<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - ค่าเฉลี่ยข้อมูล</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- General Styles --- */
      :root {
        --primary-color: #0d6efd;
      }

      body {
        font-family: "Sarabun", sans-serif;
        margin: 0;
        background-color: #f0f2f5;
        color: #333;
        display: flex; /* << ทำให้ Sidebar และ Main Content อยู่ข้างกัน */
        height: 100vh;
        overflow: hidden;
      }

      /* --- Sidebar --- */
      .sidebar {
        width: 260px; /* ความกว้างปกติ */
        background-color: #ffffff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        transition: width 0.3s ease-in-out; /* Animation */
        box-sizing: border-box;
        overflow-x: hidden;
      }

      .sidebar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        white-space: nowrap;
      }

      .sidebar h2 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--primary-color);
      }

      .hamburger-icon {
        font-size: 22px;
        color: #333;
        cursor: pointer;
        padding: 5px;
      }

      .sidebar nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .sidebar nav li a {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px 15px;
        text-decoration: none;
        color: #555;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: background-color 0.3s, color 0.3s;
        white-space: nowrap;
      }

      .sidebar nav li a.active,
      .sidebar nav li a:hover {
        background-color: var(--primary-color);
        color: white;
      }

      /* --- Collapsed Sidebar State --- */
      .sidebar.collapsed {
        width: 80px; /* ความกว้างเมื่อหด */
      }

      .sidebar.collapsed h2,
      .sidebar.collapsed .menu-text {
        display: none; /* ซ่อนข้อความ */
      }

      .sidebar.collapsed .sidebar-header,
      .sidebar.collapsed nav li a {
        justify-content: center;
      }

      .sidebar.collapsed nav li a {
        padding: 15px;
      }

      /* --- Main Content --- */
      .main-content {
        flex-grow: 1; /* << ทำให้ขยายเต็มพื้นที่ที่เหลือ */
        padding: 30px;
        overflow-y: auto;
      }

      .header-section {
        display: flex;
        flex-wrap: wrap; /* ทำให้การ์ดขึ้นบรรทัดใหม่ได้บนจอเล็ก */
        gap: 20px;
        margin-bottom: 25px;
      }

      .data-card,
      .date-picker-card {
        background-color: #fff;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        text-align: center;
        flex: 1 1 200px; /* ให้การ์ดยืดหยุ่น */
      }

      .data-card h3 {
        margin: 0 0 5px 0;
        font-size: 1rem;
        color: #6c757d;
        font-weight: normal;
      }

      .data-card p {
        margin: 0;
        font-size: 1.75rem;
        font-weight: bold;
        color: var(--primary-color);
      }

      .date-picker-card {
        background-color: #fff;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      .date-picker-card label {
        display: block;
        margin-bottom: 5px;
        color: #6c757d;
      }
      .date-picker-card select {
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
        font-family: "Sarabun", sans-serif;
        min-width: 200px;
        cursor: pointer;
      }

      /* --- ✨ CHART SECTION (ส่วนที่แก้ไข) --- */

      /* 1. สร้าง container หลักสำหรับจัดวางชาร์ตทั้งหมดในแนวตั้ง */
      .charts-section {
        display: flex;
        flex-direction: column;
        gap: 20px; /* ระยะห่างระหว่างแถวของกราฟ */
      }

      /* 2. สร้างแถวสำหรับกราฟ 2 อันบน โดยใช้ Flexbox */
      .chart-row {
        display: flex;
        gap: 20px; /* ระยะห่างระหว่างกราฟ 2 อันบน */
      }

      /* 3. สั่งให้ chart-container ที่อยู่ใน chart-row แบ่งพื้นที่เท่ากัน */
      .chart-row .chart-container {
        flex: 1; /* << คำสั่งสำคัญ: แบ่งพื้นที่เท่ากัน */
        min-width: 0; /* ป้องกันปัญหาการล้น */
      }

      /* 4. Style ของกล่องครอบกราฟ (ใช้ร่วมกันทุกกราฟ) */
      .chart-container {
        background-color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        min-height: 350px;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar" id="mySidebar">
      <div class="sidebar-header">
        <h2>ระบบรดน้ำทุเรียน</h2>
        <i class="fas fa-bars hamburger-icon" onclick="toggleMenu()"></i>
      </div>
      <nav>
        <ul>
          <li>
            <a href="index.html">
              <i class="fas fa-table-cells-large"></i>
              <span class="menu-text">ข้อมูลและการควบคุม</span>
            </a>
          </li>
          <li>
            <a href="#" class="active">
              <i class="fas fa-chart-line"></i>
              <span class="menu-text">ค่าเฉลี่ยข้อมูล</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <section class="header-section">
        <div class="data-card">
          <h3>ข้อมูลอุณหภูมิ</h3>
          <p id="avg-temp">29.5 °C</p>
        </div>
        <div class="data-card">
          <h3>ข้อมูลความชื้นดิน</h3>
          <p id="avg-soil">58 %</p>
        </div>
        <div class="data-card">
          <h3>ข้อมูลความชื้น</h3>
          <p id="avg-humidity">72 %</p>
        </div>
        <div class="date-picker-card">
            <label for="data-date">วันที่ในการเก็บข้อมูล</label>
            <select id="data-date">
              <option value="">กำลังโหลดข้อมูล...</option>
            </select>
          </div>
      </section>

      <section class="charts-section">
        <div class="chart-row">
          <div class="chart-container">
            <canvas id="tempChart"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="soilChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="humidityChart"></canvas>
        </div>
      </section>
    </main>

    <script>
      // --- Menu Toggle Function ---
      function toggleMenu() {
        document.getElementById("mySidebar").classList.toggle("collapsed");
      }

      let allData = [];
      let tempChart, soilChart, humidityChart;
      let availableDates = [];

      // Function to parse CSV
      function parseCSV(csvText) {
        const lines = csvText.trim().split("\n");
        const headers = lines[0].split(",");
        const data = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(",");
          if (values.length === headers.length) {
            data.push({
              day: values[0],
              time: values[1],
              temperature: parseFloat(values[2]),
              humidity: parseFloat(values[3]),
              moisture: parseFloat(values[4]),
            });
          }
        }
        return data;
      }

      // Function to filter data by selected date
      function filterDataByDate(data, selectedDate) {
        return data.filter((row) => row.day === selectedDate);
      }

      // Function to calculate average
      function calculateAverage(data, field) {
        if (data.length === 0) return 0;
        const sum = data.reduce((acc, row) => acc + row[field], 0);
        return (sum / data.length).toFixed(1);
      }

      // Function to create a chart
      function createChart(canvasId, label, data, color, yAxisLabel) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        return new Chart(ctx, {
          type: "line",
          data: {
            labels: data.labels,
            datasets: [
              {
                label: label,
                data: data.values,
                borderColor: color,
                backgroundColor: color + "33",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: label,
                font: { size: 16, family: "Sarabun" },
              },
            },
            scales: {
              y: {
                beginAtZero: false,
                title: {
                  display: true,
                  text: yAxisLabel,
                },
              },
            },
          },
        });
      }

      // Function to update charts
      function updateCharts(filteredData) {
        const labels = filteredData.map((row) => row.time);
        const tempValues = filteredData.map((row) => row.temperature);
        const moistureValues = filteredData.map((row) => row.moisture);
        const humidityValues = filteredData.map((row) => row.humidity);

        // Update average values
        document.getElementById("avg-temp").textContent =
          calculateAverage(filteredData, "temperature") + " °C";
        document.getElementById("avg-soil").textContent =
          calculateAverage(filteredData, "moisture") + " %";
        document.getElementById("avg-humidity").textContent =
          calculateAverage(filteredData, "humidity") + " %";

        // Destroy old charts if they exist
        if (tempChart) tempChart.destroy();
        if (soilChart) soilChart.destroy();
        if (humidityChart) humidityChart.destroy();

        // Create new charts
        tempChart = createChart(
          "tempChart",
          "กราฟข้อมูลเฉลี่ยอุณหภูมิ",
          { labels, values: tempValues },
          "#ff6384",
          "องศาเซลเซียส (°C)"
        );
        soilChart = createChart(
          "soilChart",
          "กราฟข้อมูลเฉลี่ยความชื้นดิน",
          { labels, values: moistureValues },
          "#36a2eb",
          "เปอร์เซ็นต์ (%)"
        );
        humidityChart = createChart(
          "humidityChart",
          "กราฟข้อมูลเฉลี่ยความชื้น",
          { labels, values: humidityValues },
          "#4bc0c0",
          "เปอร์เซ็นต์ (%)"
        );
      }

      // Function to get unique dates from data
      function getUniqueDates(data) {
        const dates = [...new Set(data.map((row) => row.day))];
        return dates.sort((a, b) => {
          // Sort by date (newest first)
          const [dayA, monthA, yearA] = a.split("/").map(Number);
          const [dayB, monthB, yearB] = b.split("/").map(Number);
          const dateA = new Date(yearA, monthA - 1, dayA);
          const dateB = new Date(yearB, monthB - 1, dayB);
          return dateB - dateA;
        });
      }

      // Function to populate date dropdown
      function populateDateDropdown(dates) {
        const select = document.getElementById("data-date");
        select.innerHTML = "";

        dates.forEach((date, index) => {
          const option = document.createElement("option");
          option.value = date;
          option.textContent = date;
          if (index === 0) option.selected = true; // Select the latest date
          select.appendChild(option);
        });
      }

      // Load CSV data
      async function loadData() {
        try {
          const response = await fetch("data/DataDHT.csv");
          const csvText = await response.text();
          allData = parseCSV(csvText);

          // Get unique dates and populate dropdown
          availableDates = getUniqueDates(allData);
          populateDateDropdown(availableDates);

          // Show data for the latest date
          const latestDate = availableDates[0];
          const latestData = filterDataByDate(allData, latestDate);
          updateCharts(latestData);
        } catch (error) {
          console.error("Error loading CSV:", error);
          document.getElementById("data-date").innerHTML =
            "<option>ไม่สามารถโหลดข้อมูลได้</option>";
        }
      }

      function toggleMenu() {
        document.getElementById("mySidebar").classList.toggle("collapsed");
      }

      // Event listener for date picker
      document
        .getElementById("data-date")
        .addEventListener("change", function (e) {
          const selectedDate = e.target.value;
          const filteredData = filterDataByDate(allData, selectedDate);
          updateCharts(filteredData);
        });

      // Load data when page loads
      window.onload = loadData;
    </script>
  </body>
</html>
